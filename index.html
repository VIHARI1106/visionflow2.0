<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Software Design Diagram Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
        }
        .mermaid svg {
            display: block;
            margin: auto;
            background-color: #1f2937; /* Match the panel bg for saved image */
        }
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background-color: #4f46e5;
            color: #ffffff;
        }
        .tab-btn:not(.active) {
            background-color: #374151;
            color: #d1d5db;
        }
        .gen-btn {
             @apply w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500 transition-transform transform hover:scale-105 duration-300 disabled:opacity-50 disabled:cursor-not-allowed;
        }
        .error-input {
            @apply ring-2 ring-red-500 border-red-500;
        }
        .secondary-btn {
             @apply bg-gray-600 hover:bg-gray-700 focus:ring-gray-500;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto px-4 py-8 md:py-12">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-white">
                AI Software Design Diagram Generator
            </h1>
            <p class="mt-3 text-lg text-gray-400">
                A structured workflow from problem statement to detailed UML and DFD diagrams.
            </p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input & Control Section -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                 <div>
                    <h2 class="text-2xl font-semibold mb-2 text-indigo-400">Step 1: Provide Problem Statement</h2>
                    <textarea id="problemStatement" class="w-full h-28 p-4 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 transition duration-200 resize-none" placeholder="Describe the system to generate its diagrams... e.g., 'A library management system'"></textarea>
                    <div id="dfdError" class="text-red-400 text-sm mt-2 h-5"></div>
                    
                    <div class="grid grid-cols-1 gap-3 mt-3">
                        <h3 class="text-xl font-semibold text-indigo-400 border-t border-gray-700 pt-3">Step 2: Generate DFDs Sequentially</h3>
                        <button id="generateDfd0" class="gen-btn !py-2 !text-sm">Generate DFD Level 0 (Context)</button>
                        <button id="generateDfd1" class="gen-btn !py-2 !text-sm" disabled>Generate DFD Level 1 (from Level 0)</button>
                        
                        <div id="level2Container" class="hidden">
                            <h4 class="text-md font-medium text-gray-300 mb-2 border-t border-gray-700 pt-3">Expand Level 1 Processes to Level 2:</h4>
                            <div id="level2ProcessButtons" class="grid grid-cols-2 gap-2"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-3 mt-4">
                         <h3 class="text-xl font-semibold text-indigo-400 border-t border-gray-700 pt-3">Step 3: Derive UML Diagrams</h3>
                         <p class="text-sm text-gray-400 -mt-2">Use the generated DFD in the output panel to derive other diagrams.</p>
                        <button id="deriveClass" class="gen-btn secondary-btn !py-2 !text-sm" disabled>Generate Class Diagram (from DFD Lvl 1)</button>
                        <div id="sequenceContainer" class="hidden">
                             <h4 class="text-md font-medium text-gray-300 mb-2 border-t border-gray-700 pt-3">Generate Sequence Diagrams (from DFD Lvl 2):</h4>
                             <div id="sequenceProcessButtons" class="grid grid-cols-2 gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output Section -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-400">Result</h2>
                    <div class="flex items-center space-x-2">
                        <span id="outputStatus" class="text-sm font-medium text-gray-400">Awaiting input...</span>
                        <button id="saveBtn" class="gen-btn secondary-btn !py-1 !px-3 !w-auto text-xs" disabled>Save as PNG</button>
                    </div>
                </div>
                <div id="outputContainer" class="relative min-h-[300px] flex items-center justify-center bg-gray-900 p-4 rounded-lg border border-gray-700">
                    <div id="loader" class="hidden absolute flex-col items-center">
                        <svg class="animate-spin h-8 w-8 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="mt-2 text-gray-400">Generating diagram...</p>
                    </div>
                    <div id="diagramOutput" class="w-full"><p id="placeholder" class="text-gray-500 text-center">Your generated diagram will appear here.</p></div>
                </div>
                <div class="mt-4">
                    <h3 class="text-lg font-medium text-gray-300 mb-2">Generated Mermaid Code</h3>
                    <div class="relative">
                         <pre class="bg-gray-900 text-gray-300 p-4 rounded-lg overflow-x-auto text-sm h-48"><code id="codeOutput"></code></pre>
                         <button id="copyBtn" class="absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded-md text-xs transition-colors">Copy</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });

            // --- STATE MANAGEMENT ---
            const state = {
                dfdCode: { 0: '', 1: '', 2: {} },
                level1Processes: [],
                level2Processes: {},
            };

            // --- UI ELEMENTS ---
            const ui = {
                inputs: { statement: document.getElementById('problemStatement') },
                buttons: {
                    dfd0: document.getElementById('generateDfd0'),
                    dfd1: document.getElementById('generateDfd1'),
                    level2Container: document.getElementById('level2Container'),
                    level2ProcessContainer: document.getElementById('level2ProcessButtons'),
                    deriveClass: document.getElementById('deriveClass'),
                    sequenceContainer: document.getElementById('sequenceContainer'),
                    sequenceProcessContainer: document.getElementById('sequenceProcessButtons'),
                    copy: document.getElementById('copyBtn'),
                    save: document.getElementById('saveBtn'),
                },
                outputs: {
                    diagram: document.getElementById('diagramOutput'),
                    code: document.getElementById('codeOutput'),
                    status: document.getElementById('outputStatus'),
                    loader: document.getElementById('loader'),
                    placeholder: document.getElementById('placeholder'),
                },
                errors: { dfd: document.getElementById('dfdError') }
            };
            
            // --- UI LOGIC ---
            function updateWorkflowButtons() {
                const hasDiagram = !!ui.outputs.diagram.querySelector('svg');
                ui.buttons.save.disabled = !hasDiagram;

                const hasLvl0 = !!state.dfdCode[0];
                ui.buttons.dfd1.disabled = !hasLvl0;

                const hasLvl1 = !!state.dfdCode[1];
                ui.buttons.deriveClass.disabled = !hasLvl1;
                ui.buttons.level2Container.classList.toggle('hidden', !hasLvl1);

                ui.buttons.level2ProcessContainer.innerHTML = '';
                if (hasLvl1) {
                    state.level1Processes.forEach(proc => {
                        const btn = document.createElement('button');
                        btn.className = 'gen-btn secondary-btn !py-2 !text-xs';
                        btn.textContent = `Expand: ${proc}`;
                        btn.onclick = () => handleGenerateDfd2(proc);
                        ui.buttons.level2ProcessContainer.appendChild(btn);
                    });
                }
                
                const hasAnyLvl2 = Object.keys(state.dfdCode[2]).length > 0;
                ui.buttons.sequenceContainer.classList.toggle('hidden', !hasAnyLvl2);

                ui.buttons.sequenceProcessContainer.innerHTML = '';
                 if (hasAnyLvl2) {
                    Object.keys(state.level2Processes).forEach(parentProc => {
                        const btn = document.createElement('button');
                        btn.className = 'gen-btn secondary-btn !py-2 !text-xs';
                        btn.textContent = `Sequence for: ${parentProc}`;
                        btn.onclick = () => handleDeriveSequence(parentProc);
                        ui.buttons.sequenceProcessContainer.appendChild(btn);
                    });
                }
            }
            
            function showError(message) {
                ui.errors.dfd.textContent = message;
                ui.inputs.statement.classList.add('error-input');
                setTimeout(() => {
                    ui.errors.dfd.textContent = '';
                    ui.inputs.statement.classList.remove('error-input');
                }, 3000);
            }

            // --- API & RENDERING LOGIC ---
            async function callGemini(systemPrompt, userQuery) {
                const apiKey = "AIzaSyDouHhMTNQG8Hx3z4RBd2ED4NJJ8Ul09uY";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (!candidate?.content?.parts?.[0]?.text) throw new Error('No content from API.');
                return candidate.content.parts[0].text;
            }

            function getSystemPrompt(type) {
                const base = `You are an expert software engineer. Your task is to convert a user request into a valid Mermaid.js syntax. Output ONLY the Mermaid.js code block, without any explanations or markdown fences.`;
                const prompts = {
                    'dfd_0': `${base} For DFD Level 0 (Context Diagram), use 'graph TD'. CRITICAL RULE: The diagram MUST contain exactly ONE process node representing the whole system (e.g., '0("System Name")'). Show external entities using square brackets (e.g., '[User]'). Show data flows between the single process and the external entities ONLY. DO NOT include any data stores.`,
                    'dfd_1': `${base} For DFDs, use 'graph TD'. Break down the main process into major sub-processes (e.g., "1(Process A)"). Introduce data stores [(Store)]. Show data flows between processes, entities, and stores.`,
                    'dfd_2': `${base} For DFDs, use 'graph TD'. Expand ONE specific process from a Level 1 DFD into smaller, more detailed sub-processes (e.g., "1.1(Sub-Process)"). Show granular data flows.`,
                    'class': `${base} For Class diagrams, use 'classDiagram'. Identify classes, attributes, methods, and relationships (e.g., -->, --o, --*, <|--). Use the <<enumeration>> stereotype for enums.`,
                    'sequence': `${base} For Sequence diagrams, use 'sequenceDiagram'. Identify participants and the chronological sequence of messages between them.`
                };
                return prompts[type] || base;
            }
            
            function cleanMermaidCode(code) {
                let cleanedCode = code.replace(/^```mermaid\n?/, '').replace(/\n?```$/, '').trim();

                // --- GLOBAL FIXES (run before splitting into lines) ---
                // Add newlines before keywords that must start a new line. Handles `...}class...` error.
                 cleanedCode = cleanedCode.replace(/(\w|\)|\]|"|\})\s*(subgraph|end|class|[\d.a-zA-Z_]+\()/g, '$1\n$2');


                // Reformat invalid single-line enumerations into valid multi-line ones.
                cleanedCode = cleanedCode.replace(/class\s+(?<name>\w+)\s+<<enumeration>>\s*\{(?<members>.*?)\}/g, (match, name, members) => {
                    const memberList = members.split(/,/).map(m => m.trim()).filter(Boolean).join('\n  ');
                    return `class ${name} {\n  <<enumeration>>\n  ${memberList}\n}`;
                });

                const lines = cleanedCode.split('\n');
                const processedLines = lines.map(line => {
                    let currentLine = line.trim();
                    if (currentLine.startsWith('%%') || currentLine === '') return currentLine;
                    
                    currentLine = currentLine.replace(/enum\s+(\w+)\s*\{/g, 'class $1 {\n<<enumeration>>');
                    currentLine = currentLine.replace(/(participant\s+)"([^"]*):([^"]*)"/g, '$1"$2 - $3"');
                    
                    if (currentLine.match(/^subgraph\s*(end|subgraph|$)/)) {
                       currentLine = currentLine.replace(/^subgraph\s*/, 'subgraph "Untitled"\n');
                    }

                    const colonMatch = currentLine.match(/^(?<source>.+?)\s*-->(?<destinationAndJunk>.+?)\s*:\s*(?<label>.+)$/);
                     if (colonMatch) {
                        const { source, destinationAndJunk, label } = colonMatch.groups;
                        const destMatch = destinationAndJunk.trim().match(/^[\w\d\(\)\[\]{}"]+/);
                        if(destMatch) {
                            const destination = destMatch[0];
                            return `${source.trim()} -- "${label.trim().replace(/"/g, "'")}" --> ${destination}`;
                        }
                    }

                    if (currentLine.includes('-->')) {
                        const linkMatch = currentLine.match(/^(?<source>.+?)\s*--(?<label>.*?)\s*-->(?<destinationAndJunk>.*)$/);
                        if (linkMatch) {
                            let { source, label, destinationAndJunk } = linkMatch.groups;
                            source = source.trim();
                            label = label.trim();
                            const destMatch = destinationAndJunk.trim().match(/^[\w\d\(\)\[\]{}"]+/);
                            if(destMatch) {
                                const destination = destMatch[0];
                                if (label) {
                                    label = label.replace(/^\||\|$|^"|"$/g, '').trim().replace(/"/g, "'"); 
                                    return `${source} -- "${label}" --> ${destination}`;
                                } else {
                                    return `${source} --> ${destination}`;
                                }
                            }
                        }
                    }
                    return currentLine;
                });
                return processedLines.join('\n');
            }
            
            async function generateAndRender(prompt, statusText, promptType) {
                ui.outputs.placeholder.classList.add('hidden');
                ui.outputs.diagram.innerHTML = '';
                ui.outputs.loader.classList.remove('hidden');
                ui.outputs.status.textContent = `Generating ${statusText}...`;
                let mermaidCode = null;

                try {
                    const systemPrompt = getSystemPrompt(promptType);
                    const rawCode = await callGemini(systemPrompt, prompt);
                    mermaidCode = cleanMermaidCode(rawCode);
                    
                    ui.outputs.code.textContent = mermaidCode;
                    const { svg } = await mermaid.render('graphDiv' + Date.now(), mermaidCode);
                    ui.outputs.diagram.innerHTML = svg;
                    ui.outputs.status.textContent = `Generated: ${statusText}`;
                    
                    if (promptType === 'dfd_0') {
                        state.dfdCode[0] = mermaidCode;
                    } else if (promptType === 'dfd_1') {
                        state.dfdCode[1] = mermaidCode;
                        const matches = [...mermaidCode.matchAll(/\d+\(\s*"?([^")]+)"?\s*\)/g)];
                        state.level1Processes = matches.map(m => m[1]);
                    } else if (promptType.startsWith('dfd_2_')) {
                        const parentProc = promptType.replace('dfd_2_', '');
                        state.dfdCode[2][parentProc] = mermaidCode;
                        state.level2Processes[parentProc] = true; 
                    }
                } catch (error) {
                    console.error('Error:', error);
                    ui.outputs.diagram.innerHTML = `<p class="text-red-400 text-center">Failed to render diagram. ${error.message}</p>`;
                    ui.outputs.status.textContent = `Error`;
                } finally {
                    ui.outputs.loader.classList.add('hidden');
                    updateWorkflowButtons();
                }
            }
            
            // --- EVENT HANDLERS ---
            ui.buttons.dfd0.addEventListener('click', () => {
                const statement = ui.inputs.statement.value.trim();
                if (!statement) { return showError('Problem Statement is required.'); }
                const prompt = `Generate a Level 0 DFD (Context Diagram) for: "${statement}"`;
                generateAndRender(prompt, "DFD Level 0", "dfd_0");
            });

            ui.buttons.dfd1.addEventListener('click', () => {
                const prompt = `From the following Level 0 DFD, generate a Level 1 DFD that breaks down the main process into sub-processes with data stores.\n\nLevel 0 DFD:\n${state.dfdCode[0]}`;
                generateAndRender(prompt, "DFD Level 1", "dfd_1");
            });
            
            function handleGenerateDfd2(processName) {
                const prompt = `From the following Level 1 DFD, generate a Level 2 DFD that expands only the "${processName}" process into detailed sub-processes.\n\nLevel 1 DFD:\n${state.dfdCode[1]}`;
                generateAndRender(prompt, `DFD Lvl 2 for ${processName}`, `dfd_2_${processName}`);
            }
            
            ui.buttons.deriveClass.addEventListener('click', () => {
                const prompt = `Based on the data stores and flows in this Level 1 DFD, generate a detailed Class Diagram with attributes and methods.\n\nLevel 1 DFD:\n${state.dfdCode[1]}`;
                generateAndRender(prompt, "Derived Class Diagram", "class");
            });
            
            function handleDeriveSequence(parentProc) {
                const prompt = `Based on the interactions in this Level 2 DFD for the '${parentProc}' process, generate a corresponding Sequence Diagram.\n\nLevel 2 DFD:\n${state.dfdCode[2][parentProc]}`;
                generateAndRender(prompt, `Sequence for ${parentProc}`, "sequence");
            }
            
            ui.buttons.copy.addEventListener('click', () => {
                if (!ui.outputs.code.textContent) return;
                navigator.clipboard.writeText(ui.outputs.code.textContent).then(() => {
                    ui.buttons.copy.textContent = 'Copied!';
                    setTimeout(() => { ui.buttons.copy.textContent = 'Copy'; }, 2000);
                });
            });

            ui.buttons.save.addEventListener('click', () => {
                const svgElement = ui.outputs.diagram.querySelector('svg');
                if (!svgElement) return;

                const svgData = new XMLSerializer().serializeToString(svgElement);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    const pngFile = canvas.toDataURL('image/png');
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.download = 'diagram.png';
                    downloadLink.href = pngFile;
                    downloadLink.click();
                };
                
                const url = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
                img.src = url;
            });
            
            // --- INITIALIZATION ---
            updateWorkflowButtons();
        });
    </script>
</body>
</html>

